# Helm Chart for the Science Portal user interface

See the [Deployment Guide](../README.md) for a better idea of the underlying APIs.

## Dependencies

- An existing Kubernetes cluster.
- An IVOA Registry (See the [Current SKAO Registry](https://spsrc27.iaa.csic.es/reg))
- A working Science Platform system

## Install

The Science Portal is a Single Page Application (SPA) with a rich Javascript client and DOM manager.  It uses React to power the various Dashboard elements, and is configurable for different OpenID Providers (OIdP).

### Minimum Helm configuration

See the full set of options in the [values.yaml](https://github.com/opencadc/science-platform/blob/SP-3544/deployment/helm/science-portal/values.yaml).  The deployed Redirect URI (`redirect_uri`) is `/science-portal/oidc-callback`, which handles
receiving the `code` as part of the authorization code flow, and obtaining a token to put into a cookie.

`my-science-portal-local-values-file.yaml`
```yaml
deployment:
  hostname: example.com # Change this!
  sciencePortal:
    # OIDC (IAM) server configuration.  These are required
    oidc:
      # Location of the OpenID Provider (OIdP), and where users will login
      uri: https://ska-iam.stfc.ac.uk/

      # The Client ID as listed on the OIdP.  Create one at the uri above.
      clientID: 

      # The Client Secret, which should be generated by the OIdP.
      clientSecret: 

      # Where the OIdP should send the User after successful authentication.  This is also known as the redirect_uri in OpenID.  This URI NEEDS
      redirectURI: https://example.com/science-portal/oidc-callback

      # Where to redirect to after the redirectURI callback has completed.  This will almost always be the URL to the /science-portal main page (https://example.com/science-portal).
      callbackURI: https://example.com/science-portal/

      # The standard OpenID scopes for token requests.  This is required, and if using the SKAO IAM, can be left as-is.
      scope: "openid profile offline_access"

    # Optionally mount a custom CA certificate
    # extraVolumeMounts:
    # - mountPath: "/config/cacerts"
    #   name: cacert-volume

    # Create the CA certificate volume to be mounted in extraVolumeMounts
    # extraVolumes:
    # - name: cacert-volume
    #   secret:
    #     defaultMode: 420
    #     secretName: science-portal-cacert-secret

    # The Resource ID of the Service that contains the URL of the Skaha service in the IVOA Registry
    skahaResourceID: ivo://example.org/skaha

    # The logo in the top left.  No link associated, just the image.  This can be relative, or absolute.
    # Default is the SRCNet Logo.
    # logoURL: /science-portal/images/SRCNetLogo.png

# secrets:
  # Uncomment to enable local or self-signed CA certificates for your domain to be trusted.
  # science-portal-cacert-secret:
    # ca.crt: <base64 encoded ca.crt blob>
```

### Run with configured values

```bash
helm repo update

helm install -n skaha-system --values my-science-portal-local-values-file.yaml scienceportal science-platform/scienceportal

Release "scienceportal" has been installed. Happy Helming!
NAME: scienceportal
LAST DEPLOYED: Thu Oct 19 11:59:15 2023
NAMESPACE: skaha-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

## Authentication & Authorization

A&A is handle by caching the Token Set server side and issuing a cookie to the browser to enable secure retrieval.  See the [Application Authentication Documentation](../../../docs/authentication/).

## Endpoints

The system will be available at the `/science-portal` endpoint, (i.e. https://example.com/science-portal).  Authenticating to the system is mandatory.
