# Helm Chart for the User Storage user interface

See the [Deployment Guide](../README.md) for a better idea of the underlying APIs.

## Dependencies

- An existing Kubernetes cluster.
- An IVOA Registry (See the [Current SKAO Registry](https://spsrc27.iaa.csic.es/reg))
- A working Cavern (User Storage) system

## Install

The Science Portal is a Single Page Application (SPA) with a rich Javascript client and DOM manager.  It uses React to power the various Dashboard elements, and is configurable for different OpenID Providers (OIdP).

### Minimum Helm configuration

See the full set of options in the [values.yaml](https://github.com/opencadc/science-platform/blob/SP-3544/deployment/helm/storage-ui/values.yaml).  The deployed Redirect URI (`redirect_uri`) is `/storage-ui/oidc-callback`, which handles
receiving the `code` as part of the authorization code flow, and obtaining a token to put into a cookie.

`my-storage-ui-local-values-file.yaml`
```yaml
deployment:
  hostname: example.com # Change this!
  storageUI:
    # OIDC (IAM) server configuration.  These are required
    oidc:
      # Location of the OpenID Provider (OIdP), and where users will login
      uri: https://ska-iam.stfc.ac.uk/

      # The Client ID as listed on the OIdP.  Create one at the uri above.
      clientID: <myclientid>

      # The Client Secret, which should be generated by the OIdP.
      clientSecret: <myclientsecret>

      # Used instead of clientSecret above.  Useful to avoid setting the clientSecret explicitly.
      existingSecretName: <kubernetes-secret-name>

      # Where the OIdP should send the User after successful authentication.  This is also known as the redirect_uri in OpenID.  This URI NEEDS
      redirectURI: https://example.com/storage/oidc-callback

      # Where to redirect to after the redirectURI callback has completed.  This will almost always be the URL to the /storage-ui main page (https://example.com/storage-ui).
      callbackURI: https://example.com/storage/list

      # The standard OpenID scopes for token requests.  This is required, and if using the SKAO IAM, can be left as-is.
      scope: "openid profile offline_access"

    # ID (URI) of the GMS Service.
    gmsID: ivo://skao.int/gms

    # Backend services
    backend:
      defaultService: cavern
      services:
        cavern:
          resourceID: "ivo://example.org/cavern"
          nodeURIPrefix: "vos://example.org~cavern" # How VOSpace URIs will be prefixed
          userHomeDir: "/home"
          # Some VOSpace services support these features.  Cavern does not, but it needs to be explicitly declared here.
          features:
            batchDownload: false
            batchUpload: false
            externalLinks: false
            paging: false

    # Specify the SRC theme.
    themeName: src

    # Optionally mount a custom CA certificate
    # extraVolumeMounts:
    # - mountPath: "/config/cacerts"
    #   name: cacert-volume

    # Create the CA certificate volume to be mounted in extraVolumeMounts
    # extraVolumes:
    # - name: cacert-volume
    #   secret:
    #     defaultMode: 420
    #     secretName: storage-ui-cacert-secret

# secrets:
  # Uncomment to enable local or self-signed CA certificates for your domain to be trusted.
  # storage-ui-cacert-secret:
    # ca.crt: <base64 encoded ca.crt blob>
```

### Run with configured values

```bash
helm repo add science-platform-client https://images.opencadc.org/chartrepo/client
helm repo update

helm install -n skaha-system --values my-storage-ui-local-values-file.yaml storageui science-platform-client/storageui

Release "storageui" has been installed. Happy Helming!
NAME: storageui
LAST DEPLOYED: Thu Jan 12 17:01:07 2024
NAMESPACE: skaha-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

## Authentication & Authorization

A&A is handle by caching the Token Set server side and issuing a cookie to the browser to enable secure retrieval.  See the [Application Authentication Documentation](../../../docs/authentication/).

## Endpoints

The system will be available at the `/storage` endpoint, (i.e. https://example.com/storage/list).  Authenticating to the system is optional.
